@using Project.Constraints.Models.Request
@using System.Collections
@using System.Data
@using Project.Constraints.UI.Extensions
@typeparam TRowData
@typeparam TQuery where TQuery : IRequest, new()
<Card>
    <Table DataSource="Datas"
           Loading="@Options.Loading"
           Bordered="@true"
           Resizable="@true"
           DefaultExpandAllRows="@true"
           Size="@TableSize.Small"
           ScrollX="@Options.ScrollX"
           Total="@Total"
           @bind-PageIndex="@Options.Query.PageIndex"
           @bind-PageSize="@Options.Query.PageSize"
           HidePagination="!Options.Pager">
        <ChildContent>
            @foreach (var item in Options.Columns)
            {
                @BuildColumn(item)   
            }

        </ChildContent>
        <PaginationTemplate Context="pageContext">
            <Pagination Class="@pageContext.PaginationClass"
                        Total="@pageContext.Total"
                        PageSize="@pageContext.PageSize"
                        Current="@pageContext.PageIndex"
                        ShowTotal="TotalFragment"
                        ShowSizeChanger="@true"
                        ShowQuickJumper="@true"
                        OnChange="@PaginationChanged" />
        </PaginationTemplate>
    </Table>
</Card>

@code {
    [Parameter, NotNull] public TableOptions<TRowData, TQuery>? Options { get; set; }

    [Inject, NotNull] IStringLocalizer<TableOptions>? TableLocalizer { get; set; }

    IEnumerable<TRowData> Datas => Options.Result?.Payload ?? Enumerable.Empty<TRowData>();
    int Total => Options.Result?.TotalRecord ?? 0;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Options.NotifyChanged = () => InvokeAsync(StateHasChanged);
    }

    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     await base.OnAfterRenderAsync(firstRender);
    //     if (firstRender)
    //     {
    //         if ()
    //         await Options.RefreshAsync();
    //     }
    // }


    /// <summary>
    /// table总数
    /// </summary>
    Func<PaginationTotalContext, string> TotalFragment => (context) => $"{TableLocalizer["TableTips.Total"]}：{context.Total}";

    async Task PaginationChanged(PaginationEventArgs e)
    {
        Options.Query.PageIndex = e.Page;
        Options.Query.PageSize = e.PageSize;
        await Options.RefreshAsync();
    }

    RenderFragment BuildColumn(ColumnInfo col)
    {
        return builder => builder.Component<PropertyColumn<DataRow, object>>()
              .SetComponent(c => c.Title, col.Label)
              .SetComponent(c => c.Property, row => row[col.PropertyOrFieldName])
              .Build();
    }
}
