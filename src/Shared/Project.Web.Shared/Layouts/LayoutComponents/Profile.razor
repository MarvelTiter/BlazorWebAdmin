@using Microsoft.Extensions.DependencyInjection
@using Project.Constraints.Page
@using Project.Constraints.Services
@using Project.Constraints.UI.Dropdown
@using Project.Web.Shared.Utils;
@inject IServiceProvider Provider
@inject IStringLocalizer<Profile> Localizer
@inherits AppComponentBase

@* @UI.BuildDropdown(options) *@
<AuthorizeView>
    <Authorized>
        <NavMenuItem FitContent Title="登录用户">
            <CascadingValue Name="PasswordModify" Value="PasswordModifyHandler" IsFixed="@true">
                @UI.BuildProfile()
            </CascadingValue>
        </NavMenuItem>
    </Authorized>
    <NotAuthorized>
        <NavMenuItem Title="登录">
            <MIcon IconName="svg-login" OnClick="HandleLogout"></MIcon>
        </NavMenuItem>
    </NotAuthorized>
</AuthorizeView>

@code {
    EventCallback PasswordModifyHandler;
    private IAuthService? authService;
    protected override void OnInitialized()
    {
        base.OnInitialized();
        authService ??= Provider.GetService<IAuthService>();
        PasswordModifyHandler = EventCallback.Factory.Create(this, HandlePwdModify);
    }

    public async Task HandleLogout()
    {
        if (authService is null)
        {
            UI.AlertError("不支持的操作", "未配置登录服务!");
            return;
        }
        await AuthenticationStateProvider.ClearState();
    }

    async Task HandlePwdModify()
    {
        if (User.UserInfo == null)
            return;
        if (authService == null)
            return;
        var pwd = await UI.ShowDialogAsync<ModifyUserPassword, UserPwd>(config: config =>
        {
            config.Title = Localizer["UserPwd.Title"];
            config.PostCheckAsync = async (userPwd, validate) =>
            {
                if (userPwd == null) return false;
                var v = validate.Invoke();
                if (!v) return false;
                if (userPwd.Password != userPwd.ConfirmPassword)
                {
                    UI.Error(Localizer["UserPwd.PasswordDifference"]);
                    return false;
                }
                userPwd.UserId = User.UserInfo.UserId;
                var pass = await authService.CheckUserPasswordAsync(userPwd);
                if (!pass.IsSuccess)
                {
                    UI.Error(Localizer["UserPwd.OldPasswordError"]);
                }
                return pass.IsSuccess;
            };
        });
        var result = await authService.ModifyUserPasswordAsync(pwd);
        if (result.IsSuccess)
        {
            await HandleLogout();
        }
        else
        {
            UI.Error(result.Message ?? "");
        }
    }

}